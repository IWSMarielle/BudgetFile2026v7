<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gyrus Group - Ledger V10.4</title>
    <style>
        /* PORTAL LOGIN STYLES */
        #password-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f172a; display: flex; justify-content: center;
            align-items: center; z-index: 9999; color: white; flex-direction: column;
        }
        .login-box { 
            background: #1e293b; padding: 40px; border-radius: 12px; 
            border: 2px solid #fbbf24; text-align: center; width: 400px;
        }
        .login-box select, .login-box input { 
            padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid #475569; 
            width: 100%; text-align: center; font-size: 14px; background: #0f172a; color: white;
        }
        .btn-prime { background: #fbbf24; color: #0f172a; border: none; padding: 10px; border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%; }

        /* V10.4 ZERO-GAP STYLES */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; padding: 5px; background-color: #f1f5f9; color: #1e293b; overflow-y: hidden; }
        
        .header-main { background: #0f172a; color: #fbbf24; padding: 8px; text-align: center; border-bottom: 3px solid #fbbf24; }
        .header-main h1 { margin: 0; font-size: 16px; letter-spacing: 1px; }
        
        .toolbar { display: flex; gap: 5px; background: #fff; padding: 5px; border: 1px solid #cbd5e1; border-bottom: none; }
        .table-container { overflow: auto; border: 1px solid #cbd5e1; background: white; height: calc(100vh - 100px); }
        
        table { border-collapse: collapse; table-layout: fixed; min-width: 6000px; width: 100%; }
        
        .col-cat { width: 320px; } .col-val { width: 95px; } .col-pct { width: 60px; } 
        .col-rem { width: 200px; } .col-ytd { width: 110px; } .col-final { width: 280px; }
        
        .sticky-col { position: sticky; left: 0; background: #1e293b !important; color: white; z-index: 30; border-right: 2px solid #fbbf24; }
        
        th { padding: 2px; font-size: 10px; border: 1px solid #475569; color: white; background: #334155; height: 22px; }
        
        .category-header td { 
            background-color: #334155 !important; 
            color: #fbbf24 !important; 
            font-weight: bold; 
            font-size: 11px;
            height: 24px !important;
            border-top: 1px solid #475569;
            border-bottom: 1px solid #475569;
        }

        td { border: 1px solid #e2e8f0; padding: 0 4px; text-align: right; font-size: 11px; vertical-align: middle; height: 24px; }
        
        .name-area, .remarks-area { 
            font-size: 11px; text-align: left; background: transparent; 
            width: 100%; border: none; resize: none; height: 18px; 
            overflow: hidden; white-space: nowrap; color: inherit; display: block; line-height: 18px;
        }
        .name-area { color: white; font-weight: 600; }
        
        .val-inp { border: none; background: transparent; text-align: right; width: 100%; font-size: 11px; height: 20px; }
        .btn-add { background:#10b981; color:white; border:none; padding: 0 6px; cursor:pointer; border-radius:2px; font-weight:bold; float: right; }
        .del-btn { color: #f87171; background: none; border: none; cursor: pointer; margin-right: 5px; font-weight: bold; font-size: 14px; }

        .total-row { background-color: #f8fafc; font-weight: bold; }
        .gor-row { background-color: #dcfce7 !important; color: #166534 !important; font-weight: bold; }
        .pbt-row { background-color: #fef3c7 !important; color: #92400e !important; font-weight: bold; }
        .pat-row { background-color: #0f172a !important; color: #fbbf24 !important; font-weight: bold; }
    </style>
</head>
<body>

    <div id="password-overlay">
        <div class="login-box">
            <h1 style="color:#fbbf24; margin-bottom:15px;">CORPORATE PORTAL</h1>
            <select id="companySelect"></select>
            <input type="password" id="passInput" placeholder="Access Code">
            <button class="btn-prime" onclick="checkAccess()">UNLOCK</button>
        </div>
    </div>

    <div id="main-content" style="display:none;">
        <div class="header-main"><h1 id="activeCoTitle">Gyrus Industries Corporation</h1></div>
        <div class="toolbar">
            <button onclick="exportToFile()" style="padding:2px 10px;">ðŸ’¾ Save</button>
            <button onclick="document.getElementById('fileInput').click()" style="padding:2px 10px;">ðŸ“‚ Load</button>
            <button onclick="location.reload()" style="margin-left:auto; color:red;">Logout</button>
            <input type="file" id="fileInput" style="display:none" onchange="importFromFile(this)">
        </div>

        <div class="table-container">
            <table id="mainTable">
                <thead><tr id="monthHeaders"></tr><tr id="subHeaders"></tr></thead>
                <tr class="category-header"><td class="sticky-col col-cat">SALES REVENUE <button class="btn-add" onclick="addRow('sales')">+</button></td><td colspan="63"></td></tr>
                <tbody id="sales-rows"></tbody>
                <tr class="total-row" id="sales-total-row"></tr>
                <tr class="category-header"><td class="sticky-col col-cat">COGS <button class="btn-add" onclick="addRow('cogs')">+</button></td><td colspan="63"></td></tr>
                <tbody id="cogs-rows"></tbody>
                <tr class="total-row" id="cogs-total-row"></tr>
                <tr class="category-header"><td class="sticky-col col-cat">OPERATING EXPENSES <button class="btn-add" onclick="addRow('expenses')">+</button></td><td colspan="63"></td></tr>
                <tbody id="expenses-rows"></tbody>
                <tr class="total-row" id="expenses-total-row"></tr>
                <tr class="gor-row" id="gor-summary-row"></tr> 
                <tr class="pbt-row" id="pbt-summary-row"></tr> 
                <tr class="pat-row" id="pat-summary-row"></tr> 
            </table>
        </div>
    </div>

    <script>
        let companies = JSON.parse(localStorage.getItem('corp_registry')) || [
            { name: "GYRUS INDUSTRIES CORPORATION", pass: "GYRUS2026", id: "gyrus_data_2026" },
            { name: "IWS-TECHSERV CORPORATION", pass: "IWS2026", id: "iws_data_2026" }
        ];
        let activeDB = "";
        const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        const formatter = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        function updateDropdown() {
            document.getElementById('companySelect').innerHTML = companies.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }
        function checkAccess() {
            const id = document.getElementById('companySelect').value;
            const pass = document.getElementById('passInput').value;
            const target = companies.find(c => c.id === id);
            if (target && target.pass === pass) {
                activeDB = target.id;
                document.getElementById('password-overlay').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                document.getElementById('activeCoTitle').innerText = target.name;
                initTable();
            }
        }

        function initTable() {
            const mHead = document.getElementById('monthHeaders');
            const sHead = document.getElementById('subHeaders');
            const configs = [
                {id:'sales-total', label:'SALES TOTAL'},
                {id:'cogs-total', label:'COGS TOTAL'},
                {id:'expenses-total', label:'EXPENSES TOTAL'},
                {id:'gor-summary', label:'GOR'},
                {id:'pbt-summary', label:'PBT'},
                {id:'pat-summary', label:'PAT'}
            ];
            
            mHead.innerHTML = '<th rowspan="2" class="sticky-col col-cat">ACCOUNT CATEGORY</th>';
            months.forEach((m, idx) => {
                mHead.innerHTML += `<th colspan="${idx === 0 ? 6 : 5}">${m}</th>`;
                if(idx === 0) sHead.innerHTML += `<th class="col-val">Dec(LM)</th>`;
                sHead.innerHTML += `<th class="col-val">F</th><th class="col-val">A</th><th class="col-pct">vs F %</th><th class="col-pct">vs L %</th><th class="col-rem">Remarks</th>`;
            });
            mHead.innerHTML += `<th rowspan="2" class="col-ytd">YTD</th><th rowspan="2" class="col-final">SUMMARY</th>`;

            configs.forEach(conf => {
                const row = document.getElementById(`${conf.id}-row`);
                let html = `<td class="sticky-col col-cat">${conf.label}</td>`;
                months.forEach((_, idx) => {
                    if(idx === 0) html += `<td id="tot-0-lm-${conf.id}">0.00</td>`;
                    html += `<td id="tot-${idx}-f-${conf.id}">0.00</td><td id="tot-${idx}-a-${conf.id}">0.00</td><td id="pct-${idx}-f-${conf.id}">0%</td><td id="pct-${idx}-lm-${conf.id}">0%</td><td><textarea class="remarks-area data-save" data-key="${conf.id}-rem-${idx}" oninput="saveData()"></textarea></td>`;
                });
                html += `<td id="ytd-a-${conf.id}">0.00</td><td><textarea class="remarks-area data-save" data-key="${conf.id}-rem-final" oninput="saveData()"></textarea></td>`;
                row.innerHTML = html;
            });
            loadData();
        }

        function addRow(section, loadedData = null) {
            const tbody = document.getElementById(`${section}-rows`);
            const row = document.createElement('tr');
            row.className = `${section}-item-row`;
            let html = `<td class="sticky-col col-cat" style="display:flex; align-items:center;">
                <button class="del-btn" onclick="this.closest('tr').remove(); compute(); saveData();">Ã—</button>
                <textarea class="name-area data-save" oninput="saveData()">${loadedData ? loadedData.name : ''}</textarea>
            </td>`;
            months.forEach((_, idx) => {
                let v = loadedData ? loadedData.vals[idx] : {lm:'0', f:'0', a:'0', rem:''};
                if(idx === 0) html += `<td><input type="text" class="val-lm val-inp live-inp" value="${v.lm}"></td>`;
                html += `<td><input type="text" class="val-f val-inp live-inp" value="${v.f}"></td><td><input type="text" class="val-a val-inp live-inp" value="${v.a}"></td><td class="row-pct-f">0%</td><td class="row-pct-lm">0%</td><td><textarea class="remarks-area data-save" oninput="saveData()">${v.rem}</textarea></td>`;
            });
            html += `<td class="row-ytd-a">0</td><td><textarea class="remarks-area data-save" oninput="saveData()">${loadedData?loadedData.finalRem:''}</textarea></td>`;
            row.innerHTML = html;
            tbody.appendChild(row);
            row.querySelectorAll('.live-inp').forEach(i => i.addEventListener('input', () => { compute(); saveData(); }));
            compute();
        }

        function saveData() {
            const data = { sales: [], cogs: [], expenses: [], meta: {} };
            ['sales', 'cogs', 'expenses'].forEach(sec => {
                document.querySelectorAll(`.${sec}-item-row`).forEach(row => {
                    const rowObj = { name: row.querySelector('.name-area').value, vals: [], finalRem: row.querySelector('td:last-child textarea').value };
                    const lms = row.querySelectorAll('.val-lm'), fs = row.querySelectorAll('.val-f'), as = row.querySelectorAll('.val-a'), rems = row.querySelectorAll('.remarks-area');
                    months.forEach((_, i) => rowObj.vals.push({ lm: lms[0]?.value || '0', f: fs[i].value, a: as[i].value, rem: rems[i].value }));
                    data[sec].push(rowObj);
                });
            });
            document.querySelectorAll('.data-save[data-key]').forEach(el => data.meta[el.dataset.key] = el.value);
            localStorage.setItem(activeDB, JSON.stringify(data));
        }

        function loadData() {
            const saved = localStorage.getItem(activeDB);
            if (!saved) return;
            const data = JSON.parse(saved);
            ['sales', 'cogs', 'expenses'].forEach(sec => data[sec]?.forEach(row => addRow(sec, row)));
            document.querySelectorAll('.data-save[data-key]').forEach(el => { el.value = data.meta[el.dataset.key] || ''; });
            compute();
        }

        function compute() {
            let store = { sales: { f: Array(12).fill(0), a: Array(12).fill(0), lm: 0, ytd: 0 }, cogs: { f: Array(12).fill(0), a: Array(12).fill(0), lm: 0, ytd: 0 }, expenses: { f: Array(12).fill(0), a: Array(12).fill(0), lm: 0, ytd: 0 } };
            ['sales', 'cogs', 'expenses'].forEach(sec => {
                document.querySelectorAll(`.${sec}-item-row`).forEach(row => {
                    let rYTD = 0, vLM = parseFloat(row.querySelector('.val-lm')?.value.replace(/,/g,'')) || 0;
                    if(row.querySelector('.val-lm')) store[sec].lm += vLM;
                    const fInps = row.querySelectorAll('.val-f'), aInps = row.querySelectorAll('.val-a'), pF = row.querySelectorAll('.row-pct-f'), pL = row.querySelectorAll('.row-pct-lm');
                    aInps.forEach((ainp, i) => {
                        let a = parseFloat(ainp.value.replace(/,/g,'')) || 0, f = parseFloat(fInps[i].value.replace(/,/g,'')) || 0, prev = (i === 0) ? vLM : (parseFloat(aInps[i-1].value.replace(/,/g,'')) || 0);
                        store[sec].a[i] += a; store[sec].f[i] += f; rYTD += a;
                        pF[i].innerText = ((!f?0:(a-f)/Math.abs(f))*100).toFixed(0)+'%';
                        pL[i].innerText = ((!prev?0:(a-prev)/Math.abs(prev))*100).toFixed(0)+'%';
                    });
                    row.querySelector('.row-ytd-a').innerText = formatter.format(rYTD);
                    store[sec].ytd += rYTD;
                });
                if(document.getElementById(`tot-0-lm-${sec}-total`)) document.getElementById(`tot-0-lm-${sec}-total`).innerText = formatter.format(store[sec].lm);
                document.getElementById(`ytd-a-${sec}-total`).innerText = formatter.format(store[sec].ytd);
                months.forEach((_, i) => {
                    document.getElementById(`tot-${i}-f-${sec}-total`).innerText = formatter.format(store[sec].f[i]);
                    document.getElementById(`tot-${i}-a-${sec}-total`).innerText = formatter.format(store[sec].a[i]);
                });
            });
            let ytdPBT = 0;
            months.forEach((_, i) => {
                ['f', 'a'].forEach(m => {
                    let gor = store.sales[m][i] - store.cogs[m][i] - store.expenses[m][i];
                    document.getElementById(`tot-${i}-${m}-gor-summary`).innerText = formatter.format(gor);
                    document.getElementById(`tot-${i}-${m}-pbt-summary`).innerText = formatter.format(gor);
                    document.getElementById(`tot-${i}-${m}-pat-summary`).innerText = formatter.format(gor * 0.8);
                    if(m === 'a') ytdPBT += gor;
                });
            });
            document.getElementById(`ytd-a-gor-summary`).innerText = formatter.format(ytdPBT);
            document.getElementById(`ytd-a-pbt-summary`).innerText = formatter.format(ytdPBT);
            document.getElementById(`ytd-a-pat-summary`).innerText = formatter.format(ytdPBT * 0.8);
        }
        window.onload = updateDropdown;
    </script>
</body>
</html>
